{% extends 'base.html' %}
{% block title %}H·ªçc Th·∫ª - Flashcard App{% endblock %}

{% block body_class %}no-scroll learn-page{% endblock %}

{% block content %}
    <div class="main-container learn-page-container">

        <div class="left-column-container">
            {% set image_to_show = flashcard.front_img if is_front else flashcard.back_img %}
            {% if image_to_show %}
                <div class="flashcard-image-panel">
                    {% if image_to_show.startswith('http://') or image_to_show.startswith('https://') %}
                        <img src="{{ image_to_show }}" alt="H√¨nh ·∫£nh th·∫ª">
                    {% else %}
                        <img src="{{ url_for('api.serve_image', filename=image_to_show) }}" alt="H√¨nh ·∫£nh th·∫ª">
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <div class="flashcard-column">
            {# Th√™m ID cho flashcard #}
            <div id="main-flashcard" class="flashcard {% if not is_front %}is-back-side{% endif %}">
                <div class="flashcard-header">
                    <div class="header-left">
                        <button id="menu-toggle-btn" class="menu-toggle-btn header-icon-btn" aria-label="M·ªü menu"><i class="fas fa-bars"></i></button>
                        {# --- B·∫ÆT ƒê·∫¶U THAY ƒê·ªîI: Th√™m class c√≥ ƒëi·ªÅu ki·ªán --- #}
                        <button id="open-note-btn" class="note-button header-icon-btn {% if has_note %}has-note{% endif %}" aria-label="M·ªü ghi ch√∫"><i class="fas fa-pencil-alt"></i></button>
                        {# --- K·∫æT TH√öC THAY ƒê·ªîI --- #}
                    </div>
                    <div class="header-center">
                        <p id="card-side-text" class="card-side">{% if is_front %}M·∫∑t tr∆∞·ªõc{% else %}M·∫∑t sau{% endif %}</p>
                    </div>
                    <div class="header-right">
                        {% if can_edit %}
                            <button id="open-edit-btn" class="edit-button header-icon-btn" aria-label="S·ª≠a th·∫ª"><i class="fas fa-pen-to-square"></i></button>
                        {% endif %}
                        <button id="playAudioButton" class="play-audio-button" aria-label="Ph√°t √¢m thanh"><i class="fas fa-volume-up"></i></button>
                    </div>
                </div>

                <div id="dynamic-card-details" class="dynamic-card-details">
                    <div class="dynamic-card-details-summary">
                        <span class="summary-value correct-streak">{{ progress.correct_streak }}</span>
                        <span class="summary-separator">/</span>
                        <span class="summary-value correct-count">{{ progress.correct_count }}</span>
                        <span class="summary-separator">/</span>
                        <span class="summary-value review-count">{{ progress.review_count }}</span>
                        <i class="fas fa-chevron-down summary-icon"></i>
                    </div>
                    <div class="dynamic-card-details-full">
                        <div class="details-grid">
                            <div class="detail-item">
                                <i class="fas fa-check-circle detail-icon correct-streak-icon"></i>
                                <span class="detail-label">ƒê√∫ng li√™n ti·∫øp:</span>
                                <span class="detail-value">{{ progress.correct_streak }}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-chart-line detail-icon correct-count-icon"></i>
                                <span class="detail-label">T·ªïng ƒë√∫ng:</span>
                                <span class="detail-value">{{ progress.correct_count }}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-history detail-icon review-count-icon"></i>
                                <span class="detail-label">T·ªïng √¥n t·∫≠p:</span>
                                <span class="detail-value">{{ progress.review_count }}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-times-circle detail-icon incorrect-count-icon"></i>
                                <span class="detail-label">T·ªïng sai:</span>
                                <span class="detail-value">{{ progress.incorrect_count }}</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-exclamation-triangle detail-icon lapse-count-icon"></i>
                                <span class="detail-label">L·ª° h·∫πn:</span>
                                <span class="detail-value">{{ progress.lapse_count }}</span>
                            </div>
                            <div class="detail-item full-width">
                                <i class="fas fa-calendar-alt detail-icon last-reviewed-icon"></i>
                                <span class="detail-label">L·∫ßn cu·ªëi √¥n:</span>
                                <span class="detail-value">{% if progress.last_reviewed %}{{ progress.last_reviewed | format_unix_timestamp }}{% else %}Ch∆∞a √¥n{% endif %}</span>
                            </div>
                            <div class="detail-item full-width">
                                <i class="fas fa-clock detail-icon due-time-icon"></i>
                                <span class="detail-label">ƒê·∫øn h·∫°n ti·∫øp:</span>
                                <span class="detail-value">{% if progress.due_time %}{{ progress.due_time | format_unix_timestamp }}{% else %}N/A{% endif %}</span>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="flashcard-body">
                    <div class="scrollable-card-content">
                        <div class="card-text">
                            {%- if is_front -%}{{ flashcard.front }}{%- else -%}{{ flashcard.back }}{%- endif -%}
                        </div>
                    </div>
                </div>

                {% if image_to_show %}
                    <div id="image-popup" class="image-popup-container">
                        <button id="close-image-popup-btn" class="close-popup-btn">&times;</button>
                        {% if image_to_show.startswith('http://') or image_to_show.startswith('https://') %}
                            <img src="{{ image_to_show }}" alt="H√¨nh ·∫£nh th·∫ª">
                        {% else %}
                            <img src="{{ url_for('api.serve_image', filename=image_to_show) }}" alt="H√¨nh ·∫£nh th·∫ª">
                        {% endif %}
                    </div>
                {% endif %}

                <div class="flashcard-footer">
                    {% if is_autoplay_mode %}
                        {% if is_front %}
                            <a href="{{ url_for('flashcard.flip_card', progress_id=progress.progress_id) }}" class="button">üîÑ L·∫≠t th·∫ª</a>
                        {% else %}
                            <a href="{{ url_for('flashcard.rate_card', progress_id=progress.progress_id, response_str='next') }}" class="button primary">‚ñ∂Ô∏è Ti·∫øp theo</a>
                        {% endif %}
                    {% else %}
                        <div class="button-group">
                            {% if is_front %}
                                <a href="{{ url_for('flashcard.flip_card', progress_id=progress.progress_id) }}" class="button">üîÑ L·∫≠t th·∫ª</a>
                            {% else %}
                                {% if progress.last_reviewed is none %}
                                    <a href="{{ url_for('flashcard.rate_card', progress_id=progress.progress_id, response_str='continue') }}" class="button primary">‚ñ∂Ô∏è Ti·∫øp t·ª•c</a>
                                {% else %}
                                    <a href="{{ url_for('flashcard.rate_card', progress_id=progress.progress_id, response_str='forget') }}" class="button danger">‚ùå Qu√™n</a>
                                    <a href="{{ url_for('flashcard.rate_card', progress_id=progress.progress_id, response_str='vague') }}" class="button warning">ü§î M∆° h·ªì</a>
                                    <a href="{{ url_for('flashcard.rate_card', progress_id=progress.progress_id, response_str='remember') }}" class="button success">‚úÖ Nh·ªõ</a>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="right-column-container">
            <div class="context-panel">
                <a href="{% if user.user_role == 'admin' %}{{ url_for('admin.dashboard') }}{% else %}{{ url_for('flashcard.dashboard') }}{% endif %}" class="user-profile-link">
                    <div class="user-profile">
                        <div class="user-avatar"><i class="fas fa-user"></i></div>
                        <div class="user-info">
                            <span class="username">{{ user.username or 'User' }}</span>
                            <span class="score">ƒêi·ªÉm: {{ context_stats.total_score or 0 }}</span>
                        </div>
                    </div>
                </a>
                <div class="nav-section">
                    <h3 class="nav-section-title">B·ªô th·∫ª hi·ªán t·∫°i</h3>
                    <p>{{ context_stats.set_title }}</p>
                    <p>Ti·∫øn ƒë·ªô: {{ context_stats.set_learned_cards }} / {{ context_stats.set_total_cards }} th·∫ª</p>
                    <p>C·∫ßn √¥n: {{ context_stats.set_due_cards }} th·∫ª</p>
                    <div class="nav-section-actions">
                        <a href="{{ url_for('flashcard.select_set_page') }}" class="nav-action-button"><i class="fas fa-layer-group"></i> Ch·ªçn B·ªô Kh√°c</a>
                    </div>
                </div>
                <div class="nav-section">
                    <h3 class="nav-section-title">Ch·∫ø ƒë·ªô h·ªçc</h3>
                    <p>{{ context_stats.current_mode_display }}</p>
                    <div class="nav-section-actions">
                        <a href="{{ url_for('flashcard.select_mode') }}" class="nav-action-button"><i class="fas fa-bolt"></i> ƒê·ªïi Ch·∫ø ƒê·ªô</a>
                    </div>
                </div>
                
                {# Th√¥ng tin chi ti·∫øt c·ªßa th·∫ª (ch·ªâ hi·ªÉn th·ªã tr√™n Desktop) #}
                <div class="nav-section desktop-card-details">
                    <h3 class="nav-section-title">Chi ti·∫øt th·∫ª</h3>
                    <p>L·∫ßn ƒë√°p ƒë√∫ng li√™n ti·∫øp: <span style="font-weight: bold;">{{ progress.correct_streak }}</span></p>
                    <p>T·ªïng l·∫ßn ƒë√°p ƒë√∫ng: <span style="font-weight: bold;">{{ progress.correct_count }}</span></p>
                    <p>T·ªïng l·∫ßn √¥n t·∫≠p: <span style="font-weight: bold;">{{ progress.review_count }}</span></p>
                    <p>T·ªïng l·∫ßn ƒë√°p sai: <span style="font-weight: bold;">{{ progress.incorrect_count }}</span></p>
                    <p>S·ªë l·∫ßn l·ª° h·∫πn: <span style="font-weight: bold;">{{ progress.lapse_count }}</span></p>
                    <p>L·∫ßn cu·ªëi √¥n: {% if progress.last_reviewed %}{{ progress.last_reviewed | format_unix_timestamp }}{% else %}Ch∆∞a √¥n{% endif %}</p>
                    <p>ƒê·∫øn h·∫°n ti·∫øp theo: {% if progress.due_time %}{{ progress.due_time | format_unix_timestamp }}{% else %}N/A{% endif %}</p>
                </div>

                <hr class="nav-separator">
                <ul class="side-nav-links">
                    <li><a href="#"><i class="fas fa-cog"></i> C√†i ƒë·∫∑t</a></li>
                    <li><a href="{{ url_for('auth.logout') }}"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div id="side-nav-overlay" class="side-nav-overlay"></div>
    <nav id="side-nav" class="side-nav">
        <div class="side-nav-header">
            <a href="{% if user.user_role == 'admin' %}{{ url_for('admin.dashboard') }}{% else %}{{ url_for('flashcard.dashboard') }}{% endif %}" class="user-profile-link">
                <div class="user-profile">
                    <div class="user-avatar"><i class="fas fa-user"></i></div>
                    <div class="user-info">
                        <span class="username">{{ user.username or 'User' }}</span>
                        <span class="score">ƒêi·ªÉm: {{ context_stats.total_score or 0 }}</span>
                    </div>
                </div>
            </a>
            <button id="side-nav-close-btn" class="side-nav-close-btn">&times;</button>
        </div>
        <div class="side-nav-content">
            <div class="side-nav-main">
                <div class="nav-section">
                    <h3 class="nav-section-title">B·ªô th·∫ª hi·ªán t·∫°i</h3>
                    <p>{{ context_stats.set_title }}</p>
                    <p>Ti·∫øn ƒë·ªô: {{ context_stats.set_learned_cards }} / {{ context_stats.set_total_cards }} th·∫ª</p>
                    <p>C·∫ßn √¥n: {{ context_stats.set_due_cards }} th·∫ª</p>
                    <div class="nav-section-actions">
                        <a href="{{ url_for('flashcard.select_set_page') }}" class="nav-action-button"><i class="fas fa-layer-group"></i> Ch·ªçn B·ªô Kh√°c</a>
                    </div>
                </div>
                <div class="nav-section">
                    <h3 class="nav-section-title">Ch·∫ø ƒë·ªô h·ªçc</h3>
                    <p>{{ context_stats.current_mode_display }}</p>
                    <div class="nav-section-actions">
                        <a href="{{ url_for('flashcard.select_mode') }}" class="nav-action-button"><i class="fas fa-bolt"></i> ƒê·ªïi Ch·∫ø ƒê·ªô</a>
                    </div>
                </div>
                <hr class="nav-separator">
                <ul class="side-nav-links">
                </ul>
            </div>
            <div class="side-nav-footer">
                <ul class="side-nav-links">
                    <li><a href="#"><i class="fas fa-cog"></i> C√†i ƒë·∫∑t</a></li>
                    <li><a href="{{ url_for('auth.logout') }}"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a></li>
                </ul>
            </div>
        </div>
    </nav>
    
    <div id="note-modal" class="note-modal">
        <div class="note-modal-content">
            <span id="note-modal-close-btn" class="note-modal-close-btn">&times;</span>
            <h2>Ghi ch√∫ c√° nh√¢n</h2>
            <p>N·ªôi dung b·∫°n vi·∫øt ·ªü ƒë√¢y s·∫Ω ch·ªâ hi·ªÉn th·ªã cho ri√™ng b·∫°n.</p>
            <textarea id="note-textarea" placeholder="Vi·∫øt ghi ch√∫ c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
            <div class="note-modal-footer">
                <span id="note-save-status"></span>
                <button id="save-note-btn" class="button primary">L∆∞u Ghi ch√∫</button>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="edit-modal">
        <div class="edit-modal-content">
            <span id="edit-modal-close-btn" class="edit-modal-close-btn">&times;</span>
            <h2>S·ª≠a Flashcard</h2>
            <div class="edit-modal-body">
                <div class="form-group"><label for="edit-front">M·∫∑t tr∆∞·ªõc:</label><textarea id="edit-front" rows="3"></textarea></div>
                <div class="form-group"><label for="edit-back">M·∫∑t sau:</label><textarea id="edit-back" rows="4"></textarea></div>
                <div class="form-group"><label for="edit-front-audio">N·ªôi dung Audio m·∫∑t tr∆∞·ªõc:</label><textarea id="edit-front-audio" rows="2" placeholder="V√≠ d·ª•: en:Hello"></textarea></div>
                <div class="form-group"><label for="edit-back-audio">N·ªôi dung Audio m·∫∑t sau:</label><textarea id="edit-back-audio" rows="2" placeholder="V√≠ d·ª•: vi:Xin ch√†o"></textarea></div>
                <div class="form-group"><label for="edit-front-img">URL ·∫£nh m·∫∑t tr∆∞·ªõc:</label><input type="text" id="edit-front-img" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥"></div>
                <div class="form-group"><label for="edit-back-img">URL ·∫£nh m·∫∑t sau:</label><input type="text" id="edit-back-img" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥"></div>
            </div>
            <div class="edit-modal-footer"><span id="edit-save-status"></span><button id="save-edit-btn" class="button primary">L∆∞u thay ƒë·ªïi</button></div>
        </div>
    </div>

    <audio id="cardAudioPlayer" hidden></audio>
    <div id="jsData"
         data-flashcard-id="{{ flashcard.flashcard_id }}"
         data-is-autoplay-mode="{{ 'true' if is_autoplay_mode else 'false' }}"
         data-user-audio-settings='{{ user_audio_settings_json_string | safe }}'
         data-is-front="{{ 'true' if is_front else 'false' }}"
         data-has-back-audio-content="{{ 'true' if has_back_audio_content else 'false' }}"
         data-audio-url="{{ audio_url or '' }}"
         data-can-edit="{{ 'true' if can_edit else 'false' }}">
    </div>
{% endblock %}

{% block scripts_extra %}
    <script src="{{ url_for('static', filename='js/learn_card_audio.js') }}"></script>
    <script src="{{ url_for('static', filename='js/card_content_adjuster.js') }}"></script>
    <script src="{{ url_for('static', filename='js/image_popup_handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mobile_menu_handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/note_handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/edit_handler.js') }}"></script>
    {# Script cho Dynamic Card Details #}
    <script src="{{ url_for('static', filename='js/card_details_handler.js') }}"></script>
{% endblock %}
